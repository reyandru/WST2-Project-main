<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %} 
    <link rel="stylesheet" href="{% static 'quiz/style.css' %}">
    <title>{{ category.name }} Quiz</title>
    <style>
        h1 {
            -webkit-text-stroke: 2px red;
        }
        .question {
            margin: 20px 0;
            padding: 20px;
            background: #f0f0ff88;
            border-radius: 8px; 
            font-size: 24px;
            height: 590px;
            width: 1400px;
        }
        .questionText {
            color: black;
            font-size: 30px;
            font-weight: bold;
            height: 150px;
            margin-bottom: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .timer-wrapper {
            width: 100%;
            height: 30px;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        label {
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            height: 50px;
            padding: 10px;
            border-radius: 10px;
        }
        label:hover {
            background-color: greenyellow;
        }
        input {
            display: none;
            height: 30px;
        }
        .timer-bar {
            height: 100%;
            background-color: red;
            width: 100%;
            transition: width 1s linear;
        }
        #mute-button {
        position: absolute;
        top: 12px;
        right: 150px;
        background-color: rgba(218, 51, 51, 0.925);
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 5px;
    }
    </style>
</head>
<body>
    <div class="closeBtn">
        <a class="closeButton" href="{% url 'home' %}">Back to Home</a>
        <div id="mute-button">Mute</div>
    </div>
    <h1>{{ category.name }} Quiz</h1>
    <form method="post" action="{% url 'submit_quiz' category.id %}" id="quiz-form">
        {% csrf_token %}
        {% for question in questions %}
            <div class="question" id="question-{{ question.id }}">
                <p class="questionText">{{ question.text }}</p>
                {% for choice in question.choice_set.all %}
                    <label>
                        <input type="radio" name="question_{{ question.id }}" value="{{ choice.choice_text }}" data-answer="{{ question.answer }}">
                        {{ choice.choice_text }}
                    </label><br>
                {% endfor %}
                <div class="timer-wrapper">
                    <div class="timer-bar" id="timer-bar-{{ question.id }}"></div>
                </div>
            </div>
        {% endfor %}
        <button type="submit" id="submit-button" style="display:none;">Submit Quiz</button>
    </form>

    <audio id="start-sound" controls autoplay loop style="display:none;">
        <source src="{% static 'sounds/start_quiz.mp3' %}" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>
    <audio id="submit-sound" controls autoplay loop style="display:none;">
        <source src="{% static 'sounds/submit_quiz.mp3' %}" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>

    <script>
        let currentQuestionIndex = 0;
        let score = 0;
        const questions = document.querySelectorAll('.question');
        const submitButton = document.getElementById('submit-button');
        let timerInterval;
        const timerBars = document.querySelectorAll('.timer-bar');
        let audioMuted = false;

        function showQuestion(index) {
            if (index < questions.length) {
                questions[index].style.display = 'block';
                startTimer(index);
                if (!audioMuted) {
                    document.getElementById('start-sound').play(); 
                }
            } else {
                submitButton.style.display = 'block';
            }
        }

        function startTimer(index) {
            let timeLeft = 20;
            const timerBar = timerBars[index];

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerBar.style.width = '100%';

            timerInterval = setInterval(function() {
                timeLeft--;
                const width = (timeLeft / 20) * 100;
                timerBar.style.width = width + '%';

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    nextQuestion();
                }
            }, 1000);
        }

        function nextQuestion() {
            questions[currentQuestionIndex].style.display = 'none';
            currentQuestionIndex++;

            if (currentQuestionIndex < questions.length) {
                showQuestion(currentQuestionIndex);
            } else {
                submitButton.style.display = 'block';
            }
        }

        document.addEventListener('change', function(event) {
            if (event.target.type === 'radio') {
                const selectedChoice = event.target;
                const correctAnswer = selectedChoice.getAttribute('data-answer');
                const selectedAnswer = selectedChoice.value;

                if (selectedAnswer === correctAnswer) {
                    score++;
                }

                nextQuestion();
            }
        });

        for (let i = 1; i < questions.length; i++) {
            questions[i].style.display = 'none';
        }

        showQuestion(currentQuestionIndex);

        document.getElementById('quiz-form').onsubmit = function(event) {
            event.preventDefault();
            document.getElementById('submit-sound').play(); 
            if (currentQuestionIndex < questions.length) {
                nextQuestion();
            } else {
                this.submit();
            }
        };

        document.getElementById('mute-button').onclick = function() {
            audioMuted = !audioMuted;
            this.textContent = audioMuted ? 'Unmute' : 'Mute';
            document.getElementById('start-sound').muted = audioMuted;
            document.getElementById('submit-sound').muted = audioMuted;
        };
    </script>
</body>
</html>
