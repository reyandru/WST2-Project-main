<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'quiz/style.css' %}">
    <title>{{ category.name }} Quiz</title>
    <style>
        .question {
            display: none;
        }
        .timer {
            font-size: 20px;
            color: red;
        }
    </style>
</head>
<body>
    <div class="closeBtn">
        <a class="closeButton" href="{% url 'home' %}">Back to Home</a>
    </div>
    <h1>{{ category.name }} Quiz</h1>
    <form method="post" id="quiz-form">
        {% csrf_token %}
        {% for question in questions %}
            <div class="question" id="question-{{ question.id }}">
                <p>{{ question.text }}</p>
                {% for choice in question.choice_set.all %}
                    <label>
                        <input type="radio" name="question_{{ question.id }}" value="{{ choice.choice_text }}" data-answer="{{ question.answer }}" data-question-id="{{ question.id }}">
                        {{ choice.choice_text }}
                    </label><br>
                {% endfor %}
                <div class="timer" id="timer-{{ question.id }}">20</div>
            </div>
        {% endfor %}
        <button type="submit" id="submit-button" style="display:none;">Submit</button>
    </form>

    <script>
        let currentQuestionIndex = 0;
        let score = 0;
        const questions = document.querySelectorAll('.question');
        const submitButton = document.getElementById('submit-button');
        let timerInterval;

        function showQuestion(index) {
            if (index < questions.length) {
                questions[index].style.display = 'block';
                startTimer(index);
            } else {
                submitButton.style.display = 'block';
            }
        }

        function startTimer(index) {
            let timeLeft = 20;
            const timerElement = document.getElementById('timer-' + index);

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(function() {
                timeLeft--;
                timerElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    nextQuestion();
                }
            }, 1000);
        }

        function nextQuestion() {
            questions[currentQuestionIndex].style.display = 'none';
            currentQuestionIndex++;

            if (currentQuestionIndex < questions.length) {
                showQuestion(currentQuestionIndex);
            } else {
                submitButton.style.display = 'block';
            }
        }

        document.addEventListener('change', function(event) {
            if (event.target.type === 'radio') {
                const selectedChoice = event.target;
                const correctAnswer = selectedChoice.getAttribute('data-answer');
                const selectedAnswer = selectedChoice.value;

                if (selectedAnswer === correctAnswer) {
                    score++;
                }

                nextQuestion();
            }
        });

        for (let i = 1; i < questions.length; i++) {
            questions[i].style.display = 'none';
        }

        showQuestion(currentQuestionIndex);

        document.getElementById('quiz-form').onsubmit = function(event) {
            event.preventDefault();
            if (currentQuestionIndex < questions.length) {
                nextQuestion();
            } else {
                alert('Your score is ' + score + ' out of ' + questions.length);
                this.submit();
            }
        };
    </script>
</body>
</html>
